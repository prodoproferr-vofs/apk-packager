name: Gerar APK WebView

on:
  workflow_dispatch:
    inputs:
      url:
        description: 'URL do site'
        required: true
      nome:
        description: 'Nome do App'
        required: true
      icon:
        description: 'Ícone em base64 (opcional)'
        required: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Criar projeto Android
        run: |
          mkdir -p app/src/main/res/mipmap
          cat > local.properties << EOF
          sdk.dir=$ANDROID_HOME
          EOF

          cat > app/build.gradle << 'EOF'
          apply plugin: 'com.android.application'

          android {
              compileSdk 34
              defaultConfig {
                  applicationId "com.seuapp.${{ github.run_id }}"
                  minSdk 21
                  targetSdk 34
                  versionCode 1
                  versionName "1.0"
              }
              buildTypes {
                  release {
                      minifyEnabled false
                  }
              }
          }

          dependencies {
              implementation 'androidx.appcompat:appcompat:1.6.1'
              implementation 'androidx.webkit:webkit:1.8.0'
          }
          EOF

          cat > AndroidManifest.xml << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <manifest package="com.seuapp.${{ github.run_id }}">
              <application android:label="${{ inputs.nome }}">
                  <activity android:name=".MainActivity" android:exported="true">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN"/>
                          <category android:name="android.intent.category.LAUNCHER"/>
                      </intent-filter>
                  </activity>
              </application>
          </manifest>
          EOF

          mkdir -p app/src/main/java/com/seuapp/${{ github.run_id }}/
          cat > app/src/main/java/com/seuapp/${{ github.run_id }}/MainActivity.java << 'EOF'
          package com.seuapp.${{ github.run_id }};

          import android.os.Bundle;
          import androidx.appcompat.app.AppCompatActivity;
          import android.webkit.*;

          public class MainActivity extends AppCompatActivity {
              @Override protected void onCreate(Bundle savedInstanceState) {
                  super.onCreate(savedInstanceState);
                  WebView web = new WebView(this);
                  web.setWebViewClient(new WebViewClient());
                  WebSettings s = web.getSettings();
                  s.setJavaScriptEnabled(true);
                  s.setDomStorageEnabled(true);
                  s.setLoadWithOverviewMode(true);
                  s.setUseWideViewPort(true);
                  web.loadUrl("${{ inputs.url }}");
                  setContentView(web);
              }
              @Override public void onBackPressed() {
                  WebView web = (WebView)findViewById(android.R.id.content).getRootView();
                  if (web.canGoBack()) web.goBack(); else super.onBackPressed();
              }
          }
          EOF

          # Ícone padrão se não tiver
          if [ -n "${{ inputs.icon }}" ]; then
            echo "${{ inputs.icon }}" | base64 -d > app/src/main/res/mipmap/ic_launcher.png
          else
            curl -s https://via.placeholder.com/512/00d4aa/ffffff?text=${{ inputs.nome }} -o app/src/main/res/mipmap/ic_launcher.png
          fi

      - name: Build APK
        run: |
          cd app && ./gradlew assembleRelease --no-daemon

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.nome }}.apk
          path: app/build/outputs/apk/release/app-release-unsigned.apk
